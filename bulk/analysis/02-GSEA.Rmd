---
title: "02 - GSEA with cell type gene sigantures"
author: "Selin Jessa [[selin.jessa@mail.mcgill.ca](mailto:selin.jessa@mail.mcgill.ca)]"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    keep_md: true
    theme: flatly
    css: ../../include/style.css
    toc: yes
    toc_depth: 4
    number_sections: true
    df_print: paged
    includes:
      before_body: ../../include/header.html
      after_body:  ../../include/footer.html
---

<!-- FRONT MATTER, insert configuration info -->

```{r header, echo = FALSE, results = 'asis', warning = FALSE}

# Index of the document
# ...determines name of the subfolder of `outputs` and `figures`
doc_id <- "02"
subdir <- "bulk"

suppressMessages(library(here))

# Knit child document with header
res <- knitr::knit_child(here("include", "header.Rmd"), envir = environment(), quiet = TRUE)
cat(res, sep = '\n')

```

<!-- END OF FRONT MATTER -->


# Overview

In this document, we gather a reference of developmental gene signatures from several brain cell types and studies, and evaluate their enrichment in the differentially-expressed genes between G34 tumors and other groups. The enrichment analysis is performed with GSEA, using the package fgsea.

# Libraries

```{r libs, warning = FALSE, message = FALSE, echo = TRUE, cache = FALSE}

# General
library(tidyverse)
library(magrittr)
library(glue)

# For analysis
library(fgsea)

# For plotting
library(ggplot2)
library(scales)
library(cytobox)
library(pheatmap)
library(ggrepel)
library(cowplot)
ggplot2::theme_set(cytobox::theme_min(base_size = 13))

# Custom
source(here::here("bulk/analysis/functions.R"))

```

# Load data

## Cluster annotations

First we load cell type annotations for each of the datasets, since they are often
labelled by abbreviations. Create uniform dataframes, with at least three columns:
Cluster, Cell_type, and Age.

```{r cluster_anno}

jessa_table_2a <- read_tsv(here("bulk/data/Jessa2019_Table_2a.tsv")) %>% 
  mutate(Cluster = gsub("_", " ", Cluster)) %>% 
  mutate(Age = paste0("Mouse ", Age))

nowakowski_cluster_anno <- read_csv(here("bulk/data/Nowakowski2017_Table_4_cluster_labels_with_colours.csv")) %>%
  select(Cluster = `Cluster Name`,
         Cell_type = `Cluster Interpretation`) %>% 
  mutate(Cluster = paste0("HF ",  Cluster)) %>% 
  mutate(Age = "Human fetal")

# Give these clusters distinct numbers since they have the same "cell type"
nowakowski_cluster_anno[nowakowski_cluster_anno$Cell_type == "MGE newborn neurons", ]$Cell_type <- paste0(nowakowski_cluster_anno[nowakowski_cluster_anno$Cell_type == "MGE newborn neurons", ]$Cell_type, 1:5)

velmeshev_anno <- read_tsv(here("bulk/data/Velmeshev2019_cluster_names.tsv")) %>% 
  mutate(Age = "Human ped/adult",
         Cluster = paste0("HP ", Cluster))

cell_type_anno <- bind_rows(jessa_table_2a %>% select(Sample, Age, Cell_type, Cluster),
                            nowakowski_cluster_anno,
                            velmeshev_anno)

```

## Palettes

Create colour palettes for each dataset, for visualization:

```{r palettes}

palette_atlas <- jessa_table_2a %>% select(Cluster, Colour) %>% deframe()

palette_nowakowski <- read_csv(here("bulk/data/Nowakowski2017_Table_4_cluster_labels_with_colours.csv")) %>%
  mutate(Cluster = paste0("HF ", `Cluster Name`)) %>%
  select(Cluster, colour = Colour) %>%
  deframe()

palette_type <- c("RGC" = "#ffcc00",
                  "Oligodendrocyte precursors" = "#e0de53",
                  "Oligodendrocytes" = "#b4e04e",
                  "Astrocytes" = "#00a385",
                  "Neuronal progenitors" = "#ffbda3",
                  "Prenatal inhib. neurons" = "#8798C8",
                  "Pediatric/adult inhib. neurons" = "#135ca0",
                  "Other neurons" = "darkred")

palette_age <- c("Human fetal" = "#458cde",
                 "Mouse E12.5" = "#73a8e6",
                 "Mouse E15.5" = "#a4c6ed",
                 "Mouse P0" = "#f2b39d",
                 "Mouse P3" = "tomato",
                 "Mouse P6" = "red",
                 "Human ped/adult" = "darkred")

```

## Fetal mouse brain

Load signatures from our Nature Genetics paper:

```{r load_atlas}

# Get data from paper, filter to clusters with a valid signature, from mouse samples
jessa_table_2a_mouse_noblacklist <- jessa_table_2a %>% 
  filter(Species == "Mouse" & !is.na(Signature))

# Parse the signature column to get gene signatures as vectors
atlas_signatures <- list("mm_sym" = map(jessa_table_2a_mouse_noblacklist$Signature,
                                        ~ stringr::str_split(.x, ", ") %>%
                                          # Get the first element, otherwise we have
                                          # a list of one-element lists
                                          .[[1]]))
names(atlas_signatures$mm_sym) <- jessa_table_2a_mouse_noblacklist$Cluster

# Convert to human symbols / Ensembl IDs
atlas_signatures$hg_sym <- map(atlas_signatures$mm_sym,
                               # Filter out NAs and empty strings
                               ~ .x %>% cytobox::mm2hg() %>% .[!is.na(.)] %>% .[. != ""])
atlas_signatures$hg_ens <- map(atlas_signatures$hg_sym,
                               ~ .x %>% cytobox::symbols2ensembl() %>% .[!is.na(.)] %>% .[. != ""])

rr_saveRDS(object = atlas_signatures,
           file = glue("{out}/atlas_signatures.Rds"),
           desc = "List of gene signatures from Jessa et al 2019, with mouse and human gene symbols and ENSEMBL IDs")

```

## Fetal human brain

We've previously extracted gene signatures from this study (provided in Table S5) and prepared them in a
similar format:

```{r load_nowakowski}

load(here("bulk/data/Nowakowski2017_signatures.Rda"))

# Denote as human fetal
names(nowakowski_signatures$hg_ens) <- paste0("HF ", names(nowakowski_signatures$hg_ens))
names(nowakowski_signatures$hg_sym) <- paste0("HF ", names(nowakowski_signatures$hg_sym))

```


## Pediatric/adult human brain

```{r load_velmeshev}

velmeshev_signatures <- readRDS(here("bulk/data/Velmeshev2019_signatures.Rda"))

# Denote as human postnatal/pediatric
names(velmeshev_signatures$hg_ens) <- paste0("HP ", names(velmeshev_signatures$hg_ens))
names(velmeshev_signatures$hg_sym) <- paste0("HP ", names(velmeshev_signatures$hg_sym))

```


# Analysis

With the cell type signatures derived from the various scRNAseq studies, we can now
use these as input to GSEA, and evaluate their enrichment in differentially expressed
genes between G34R/V tumors vs. other pediatric brain tumor types.

## Prep stats

```{r prep_stats}

pipeline_path <- "../../../../../from_beluga/HGG/2019-09_bulk_RNAseq/2020-01_G34_submission1_add_samples/"

# Keep all the DGE analyses between tumor groups, accounting for batch
comps <- list.files(pipeline_path, full.names = TRUE)[
  grepl("^HGG", list.files(pipeline_path)) &
    grepl("vs", list.files(pipeline_path)) &
    grepl("batch_covariate", list.files(pipeline_path))]

names(comps) <- gsub("_batch_covariate", "", basename(comps))

# Get the file with the DESeq2 DGE output, and create a vector with the Ensembl
# gene IDs and stat for that gene, in each comparison
stats <- map(comps, ~ read_tsv(Sys.glob(file.path(.x, "diff/Ensembl.ensGene.exon/*.tsv"))) %>%
               filter(!is.na(stat)) %>%
               separate(ID, into = c("Ens", "Sym"), sep = ":") %>%
               select(Ens, stat) %>%
               deframe())

rr_saveRDS(file = glue("{out}/stats.Rds"),
           desc = "List of DESeq2 stats from differential expression analyses between tumor groups, to use for GSEA",
           stats)

```

## Run

```{r run_gsea, results = "hide", dependson = 'prep_stats'}

bulk_fgsea <- map(stats, ~ fgsea(pathways = c(atlas_signatures$hg_ens,
                                              nowakowski_signatures$hg_ens,
                                              velmeshev_signatures$hg_ens),
                                 stats   = .x,
                                 # Default params
                                 minSize = 15,
                                 maxSize = 500,
                                 nperm   = 10000))
  
rr_saveRDS(file = glue("{out}/bulk_fgsea.Rds"),
           desc = "List of results from fgsea for enrichment of cell type signatures in tumor differential expression analyses",
           object = bulk_fgsea)

```

## Filter gene signatures

Remove clusters which are proliferating based on either labeled as such, or G2M score,
as cell-cycle genes may confound GSEA enrichment scores particularly in these tumor comparisons

```{r filter_signatures, dependson = c('prep_stats', 'run_gsea'), fig.width = 20, fig.height = 4}

# 1. Atlas
# Load signatures with cell cycle scores, to quantitatively set a filter
infosig_with_cc <- read_tsv(here("bulk/data/Jessa2019_cluster_cell_cycle_scores.tsv")) %>%
  arrange(desc(Median_G2M))

infosig_with_cc %>%
  filter(Species == "Mouse") %>%
  mutate(Cluster = factor(Cluster, levels = .$Cluster)) %>%
  ggplot(aes(x = Cluster, y = Median_G2M)) +
  geom_point(aes(colour = Cluster)) +
  scale_colour_manual(values = palette_atlas) +
  # Set an arbitrary threshold, where the G2M score starts tapering off
  geom_hline(yintercept = 0.35) +
  theme_min() +
  rotateX() +
  noLegend()

atlas_sigs_keep <- infosig_with_cc %>%
  # Remove anything with G2M scores above the threshold, OR which is labelled
  # as proliferating, as indicated by a trailing "-P" in the cluster abbreviation
  filter(Median_G2M < 0.35 & !grepl("-P$", Cluster)) %>%
  # Remove anything labeled Other/Other neurons
  filter(!(Cell_class %in% c("Other", "Other neurons"))) %>%
  # Filter to only forebrain signatures
  filter(Structure == "Forebrain") %>%
  pull(Cluster)

# 2. Nowakowski
nowakowski_sigs_keep <- nowakowski_cluster_anno %>%
  # Filter out proliferating clusters
  filter(!grepl("-P$|div|G2M/S|MGE-IPC1|MGE-IPC2|prolif", Cluster)) %>%
  # Filter out Unknown
  filter(!grepl("Unknown", Cell_type)) %>%
  pull(Cluster)

# 3. Velmeshev - keep all signatures
velmeshev_sigs_keep <- names(velmeshev_signatures$hg_sym)

bulk_fgsea_filt <- map(bulk_fgsea, ~ .x %>%
                         filter(pathway %in% c(atlas_sigs_keep, nowakowski_sigs_keep, velmeshev_sigs_keep)))

```

## Tidy output

```{r tidy_df}

# A function to convert the leading edge from ENSG id to symbols
flatten_leading_edge <- function(x) {

  # Convert leading edge genes to gene symbols
  for (i in 1:nrow(x)) {

    x[i, ]$leadingEdge <- x[i, ]$leadingEdge %>% ensembl2symbols_safe() %>% glue_collapse(sep = ", ")

  }

  x$leadingEdge <- as.character(x$leadingEdge)
  x

}

fgsea_df <- imap_dfr(bulk_fgsea_filt, ~ .x %>%
                       as.data.frame() %>%
                       flatten_leading_edge() %>%
                       tibble::add_column(Comparison = .y, .before = 1) %>%
                       arrange(desc(NES))) %>%
  rename(Signature = pathway) %>%
  left_join(cell_type_anno, by = c("Signature" = "Cluster")) %>%
  select(Comparison, Signature, Sample, Age, Cell_type, everything())

# Save output
rr_write_tsv(df = fgsea_df,
             path = glue("{out}/fgsea_df.Rda"),
             desc = "Tidied dataframe with GSEA results for bulk tumor group comparisons")

```

## Top leading edge

For the IDH comparison, let's filter down the leading edge genes to those which
are the top-ranked ones i.e. rank < 2000, to ensure we have good lists to work with.

```{r fgsea_df_idh}

# Generate stats based on the gene symbols
stats_idh_sym <- read_tsv(Sys.glob(file.path(comps["HGG-G34R.V_vs_HGG-IDH"],
                                             "diff/Ensembl.ensGene.exon/*.tsv"))) %>%
  filter(!is.na(stat)) %>%
  separate(ID, into = c("Ens", "Sym"), sep = ":") %>%
  select(Sym, stat) %>%
  deframe()

# Apply filters and order by score
fgsea_df_idh_filt <- fgsea_df %>%
  filter(Comparison == "HGG-G34R.V_vs_HGG-IDH") %>%
  filter(padj < 0.01)

# Gather the pathways
pathways <- c(atlas_signatures$hg_sym,
              nowakowski_signatures$hg_sym,
              velmeshev_signatures$hg_sym)

fgsea_df_idh_filt$leadingEdge_top <- NA

# Get the top-ranked leading edge genes
for (i in 1:nrow(fgsea_df_idh_filt)) {

  genes <- str_split(fgsea_df_idh_filt[i, ]$leadingEdge, ", ") %>% getElement(1)
  sig <- fgsea_df_idh_filt[i, ]$Signature
  nes <- fgsea_df_idh_filt[i, ]$NES

  fgsea_df_idh_filt[i, ]$leadingEdge_top <- get_gene_ranks(pathway   = pathways[[sig]],
                                                           stats     = stats_idh_sym,
                                                           direction = ifelse(nes > 0, "enriched", "depleted")) %>%
    filter(gene %in% genes & rank < 2000) %>%
    pull(gene) %>%
    as.character() %>%
    glue_collapse(", ")

}

```

<!-- # Visualization -->

<!-- ```{r palettes_tumors} -->

<!-- palette_groups <- c("HGG-G34R/V"             = "#41a334", -->
<!--                     "HGG-H3.3-K27M-pons"     = "#a30300", -->
<!--                     "HGG-H3.3-K27M-thalamic" = "#f72d2a", -->
<!--                     "HGG-IDH"                = "#da00f1", -->
<!--                     "HGG-WT"                 = "#ada7a6", -->
<!--                     "PNET-HGNET-BCOR"        = "#1b24d1") -->

<!-- ``` -->

<!-- ## GSEA enrichment plots -->

<!-- The most enriched or depleted signature for each cell type: -->

<!-- ```{r enrich_plots_simple, fig.width = 10, fig.height = 6, dependson = 'prep_stats', echo_label = TRUE} -->

<!-- # A function to add the NES and adj p-value to the enrichment plot -->
<!-- plot_enrich_with_stats <- function(sig, title, source, colour) { -->

<!--   signatures = switch(source, -->
<!--                       "nowakowski" = nowakowski_signatures$hg_ens, -->
<!--                       "atlas" = atlas_signatures$hg_ens, -->
<!--                       "velmeshev" = velmeshev_signatures$hg_ens) -->

<!--   plotEnrichment2(signatures[[sig]], -->
<!--                   stats$`HGG-G34R.V_vs_HGG-IDH`, -->
<!--                   colour = colour) + -->
<!--     labs(title = paste0(title, "\nNES: ", -->
<!--                         fgsea_df_idh_filt %>% filter(Signature == sig) %>% pull(NES) %>% round(2), -->
<!--                         ", p_adj: ", -->
<!--                         fgsea_df_idh_filt %>% filter(Signature == sig) %>% pull(padj) %>% scales::scientific())) -->
<!-- } -->

<!-- # Plot for select signatures -->
<!-- p1 <- plot_enrich_with_stats("HF RG-early", "Fetal radial glia", "nowakowski", "red") -->

<!-- p2 <- plot_enrich_with_stats("HF nIN1", "Newborn inhibitory neurons", "nowakowski", "red") -->

<!-- p3 <- plot_enrich_with_stats("HP IN-PV", "Mature inhibitory neurons", "velmeshev", "blue") -->

<!-- p4 <- plot_enrich_with_stats("F-p6 OPC", "Oligodendrocyte precursors", "atlas", "blue") -->

<!-- p5 <- plot_enrich_with_stats("HF EN-PFC1", "Fetal excitatory neurons", "nowakowski", "blue") -->

<!-- # Plot the enrichment of astrocytes against HGNET-BCOR -->
<!-- p6 <- plotEnrichment2(atlas_signatures$hg_ens[["F-p0 ASTR2"]], -->
<!--                       stats$`HGG-G34R.V_vs_PNET-HGNET-BCOR`, -->
<!--                       colour = "red") + -->
<!--   labs(title = paste0("Astrocytes", "\nNES: ", -->
<!--                       fgsea_df %>% filter(Comparison == "HGG-G34R.V_vs_PNET-HGNET-BCOR" & Signature == sig) %>% -->
<!--                         pull(NES) %>% round(2), -->
<!--                       ", p_adj: ", -->
<!--                       fgsea_df %>% filter(Comparison == "HGG-G34R.V_vs_PNET-HGNET-BCOR" & Signature == sig) %>% -->
<!--                         pull(padj) %>% scales::scientific())) -->

<!-- plot_grid(p1, p2, p6, p3, p4, p5, ncol = 3) -->

<!-- ``` -->

## Heatmap across comparisons

Define a function to summarize the cell types into broader "classes",
distinguishing between different types of inhibitory neurons.

```{r summarize_cell_types}

summarizeCellTypes3 <- function(df, cluster_col) {

  cc_quo <- enquo(cluster_col)

  df %>%
    mutate(
      # Define some broader cell type classes
      Type = case_when(
        grepl("RG|[Rr]adial", !!cc_quo) & !grepl("NRGN", !!cc_quo) & !grepl("-P.{0,1}$|prolif", !!cc_quo) ~ "RGC",
        grepl("EXIP|INIP|NEURP|IP|[Ii]ntermediate", !!cc_quo) & !grepl("VIP", !!cc_quo) ~ "Neuronal progenitors",
        grepl("MGE|CGE|SST|PV|[Ii]nhib", !!cc_quo) ~ "Prenatal inhib. neurons",
        grepl("PV|SST|VIP|SV2C|Somato|Parv", !!cc_quo) ~ "Pediatric/adult inhib. neurons",
        grepl("CEX|PEX|[Ee]xcit|NRGN|[Nn]eu", !!cc_quo) ~ "Other neurons",
        grepl("OPC|Oligodendrocyte progenitor cell|Oligodendrocyte precursor", !!cc_quo) ~ "Oligodendrocyte precursors",
        grepl("NFOL|MOL|[Oo]ligo", !!cc_quo) ~ "Oligodendrocytes",
        grepl("ASTR|Astr", !!cc_quo) ~ "Astrocytes",
        TRUE ~ "Other")) %>%
    mutate(Type = factor(Type, levels = c("RGC",
                                          "RGC (prolif.)",
                                          "Neuronal progenitors",
                                          "Prenatal inhib. neurons",
                                          "Pediatric/adult inhib. neurons",
                                          "Other neurons",
                                          "Glial progenitors",
                                          "Oligodendrocyte precursors",
                                          "Oligodendrocytes",
                                          "Astrocytes",
                                          "Choroid/ependymal",
                                          "Immune",
                                          "Non-neuroectoderm",
                                          "Other")))

}

```

Generate the input data for the heatmap:

```{r gsea_heatmap_data}

# Select only signatures which are signif enriched/depleted in the IDH comparison
signif_in_idh <- fgsea_df_idh_filt$Signature

heatmap_data_long <- fgsea_df %>%
  filter(Signature %in% signif_in_idh) %>%
  # Subset to relevant cell types
  summarizeCellTypes3(Cell_type) %>%
  filter(Type %in% c("RGC",
                     "Prenatal inhib. neurons",
                     "Pediatric/adult inhib. neurons",
                     "Neuronal progenitors",
                     "Other neurons",
                     "Oligodendrocytes",
                     "Oligodendrocyte precursors",
                     "Astrocytes")) %>%
  mutate(Cell_type = paste0(Age, " ", Cell_type))

col_order <- heatmap_data_long %>%
  distinct(Cell_type, Type) %>%
  arrange(Type) %>%
  pull(Cell_type)

col_anno <- heatmap_data_long %>%
  distinct(Cell_type, Age, Type) %>%
  mutate(Species = ifelse(grepl("Mouse", Cell_type), "Mouse", "Human")) %>%
  data.frame() %>%
  tibble::column_to_rownames(var = "Cell_type")

# Include only the high-grade gliomas at first
row_order <- c("HGG-G34R.V_vs_HGG-IDH",
               "HGG-G34R.V_vs_HGG-H3.3-K27M-pons",
               "HGG-G34R.V_vs_HGG-H3.3-K27M-thalamic",
               "HGG-G34R.V_vs_HGG-WT")

heatmap_data_wide <- heatmap_data_long %>%
  select(Comparison, Cell_type, NES) %>%
  spread(Cell_type, NES) %>%
  as.data.frame() %>%
  tibble::column_to_rownames(var = "Comparison") %>%
  .[row_order, col_order]

```

```{r gsea_heatmap_hgg, echo_fig = TRUE}

hm_fun <- partial(pheatmap,
                  border_color = NA,
                  color = colorRampPalette(c("blue","white","red"))(100),
                  cluster_rows = FALSE,
                  cluster_cols = FALSE,
                  cellwidth = 12,
                  cellheight = 12,
                  annotation_colors = list("Age"  = palette_age,
                                           "Type" = palette_type,
                                           "Species" = c("Human" = "black", "Mouse" = "gray70")))

# Generate heatmap
hm_fun(mat = heatmap_data_wide,
       annotation_col = col_anno,
       filename = glue("{figout}/gsea_heatmap_hgg.pdf"))

hm_fun(mat = heatmap_data_wide,
       annotation_col = col_anno,
       filename = glue("{figout}/gsea_heatmap_hgg.png"))

knitr::include_graphics(glue("{figout}/gsea_heatmap_hgg.png"))

```

Generate a second for HGNET-BCOR:

```{r gsea_heatmap_bcor, echo_fig = TRUE}

signif_in_bcor <- fgsea_df %>%
  filter(Comparison == "HGG-G34R.V_vs_PNET-HGNET-BCOR" & padj < 0.01) %>%
  pull(Signature)

heatmap_data_long <- fgsea_df %>%
  filter(Signature %in% signif_in_bcor) %>%
  # Subset to relevant cell types
  summarizeCellTypes3(Cell_type) %>%
  filter(Type %in% c("RGC",
                     "Prenatal inhib. neurons",
                     "Pediatric/adult inhib. neurons",
                     "Neuronal progenitors",
                     "Other neurons",
                     "Oligodendrocytes",
                     "Oligodendrocyte precursors",
                     "Astrocytes")) %>%
  mutate(Cell_type = paste0(Age, " ", Cell_type)) %>%
  filter(Comparison == "HGG-G34R.V_vs_PNET-HGNET-BCOR")

col_order <- heatmap_data_long %>%
  distinct(Cell_type, Type) %>%
  arrange(Type) %>%
  pull(Cell_type)

col_anno <- heatmap_data_long %>%
  distinct(Cell_type, Age, Type) %>%
  data.frame() %>%
  tibble::column_to_rownames(var = "Cell_type")

heatmap_data_wide <- heatmap_data_long %>%
  distinct(Cell_type, Type, .keep_all = TRUE)  %>%
  select(Cell_type, NES) %>%
  spread(Cell_type, NES) %>%
  as.data.frame() %>%
  .[ , col_order]

hm_fun(mat = heatmap_data_wide,
       annotation_col = col_anno,
       filename = glue("{figout}/gsea_heatmap_bcor.pdf"))

hm_fun(mat = heatmap_data_wide,
       annotation_col = col_anno,
       filename = glue("{figout}/gsea_heatmap_bcor.png"))

knitr::include_graphics(glue("{figout}/gsea_heatmap_bcor.png"))

```



<!-- END MATTER, insert reproducibility info -->

```{r footer, echo = FALSE, results = 'asis', warning = FALSE, cache = FALSE}

# Knit child document with header
res <- knitr::knit_child(here::here("include", "footer.Rmd"), envir = environment(), quiet = TRUE)
cat(res, sep = '\n')

```

<!-- END OF END MATTER -->
